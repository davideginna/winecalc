name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  # Permette di lanciare manualmente il workflow con opzioni
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deploy only)'
        required: false
        type: boolean
        default: false
      deploy:
        description: 'Force deploy even on non-main branch'
        required: false
        type: boolean
        default: false

jobs:
  # Job 1: Test
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    # Salta i test solo se esplicitamente richiesto via workflow_dispatch
    if: ${{ !inputs.skip_tests }}

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

    - name: Generate coverage report
      if: matrix.node-version == '20.x'
      run: npm run test:coverage

    - name: Upload coverage to Codecov
      if: matrix.node-version == '20.x'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/coverage-final.json
        fail_ci_if_error: false

  # Job 2: Deploy (dipende da test, oppure se skip_tests=true)
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    # Deploy se:
    # - I test sono passati (needs: test implica success)
    # - OPPURE i test sono stati saltati (inputs.skip_tests)
    # E deploy solo su main (o se forzato)
    needs: test
    if: |
      always() &&
      (needs.test.result == 'success' || inputs.skip_tests == true) &&
      (github.ref == 'refs/heads/main' || inputs.deploy == true)

    # Permessi necessari per GitHub Pages
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # Job 3: Summary (sempre eseguito)
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Test status
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "âœ… **Tests:** Passed" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.test.result }}" == "skipped" ]; then
          echo "âš ï¸ **Tests:** Skipped (emergency mode)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Tests:** Failed" >> $GITHUB_STEP_SUMMARY
        fi

        # Deploy status
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… **Deploy:** Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live URL:** https://davideginna.github.io/winecalc/" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
          echo "â­ï¸ **Deploy:** Skipped (not main branch)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Deploy:** Failed" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

        if [ "${{ inputs.skip_tests }}" == "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Warning:** Tests were skipped!" >> $GITHUB_STEP_SUMMARY
        fi
